---
layout: post
title: "Spring源码分析——BeanPostProcessor"
date: 2019-3-16
tag: JavaEE

---

[TOC]



### spring的注解开发



###  Bean生命周期——BeanPostProcessor

容器管理bean的生命周期，创建——初始化——销毁

**创建：**

单实例是在容器初始化的时候创建对象；

多实例是在获取对象的时候创建对象；

**销毁:**

单实例，容器关闭的时候；

多实例，容器不会管理这个bean，容器不会调用销毁方法

在bean的生命周期中可以使用后置处理器**BeanPostProcessor**在对象初始化化前后添加一些逻辑，这里初始化方法是指在配置文件中配置init-method，或者实现了InitializingBean接口的afterPropertiesSet方法,注意不包括@PostConstruct这种初始化方式。可以看源码AbstractAutowireCapableBeanFactory类中的invokeInitMethods方法。

#### 源码分析

在后置处理器注册到容器中之后，会在AnnotationConfigApplicationContext的构造方法中调用refresh（）方法

```java
@Override
    public void refresh() throws BeansException, IllegalStateException {
        synchronized (this.startupShutdownMonitor) {
            // Prepare this context for refreshing.
            prepareRefresh();

            // Tell the subclass to refresh the internal bean factory.
            ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();

            // Prepare the bean factory for use in this context.
            prepareBeanFactory(beanFactory);

            try {
                // Allows post-processing of the bean factory in context subclasses.
                postProcessBeanFactory(beanFactory);

                // Invoke factory processors registered as beans in the context.
                invokeBeanFactoryPostProcessors(beanFactory);
　　　　　　　　　 //发现注册bean后置处理器，在这个方法中进行　
                // Register bean processors that intercept bean creation.
                registerBeanPostProcessors(beanFactory);

                // Initialize message source for this context.
                initMessageSource();

                // Initialize event multicaster for this context.
                initApplicationEventMulticaster();

                // Initialize other special beans in specific context subclasses.
                onRefresh();

                // Check for listener beans and register them.
                registerListeners();

                // Instantiate all remaining (non-lazy-init) singletons.
                finishBeanFactoryInitialization(beanFactory);

                // Last step: publish corresponding event.
                finishRefresh();
            }

            catch (BeansException ex) {
                if (logger.isWarnEnabled()) {
                    logger.warn("Exception encountered during context initialization - " +
                            "cancelling refresh attempt: " + ex);
                }

                // Destroy already created singletons to avoid dangling resources.
                destroyBeans();

                // Reset 'active' flag.
                cancelRefresh(ex);

                // Propagate exception to caller.
                throw ex;
            }

            finally {
                // Reset common introspection caches in Spring's core, since we
                // might not ever need metadata for singleton beans anymore...
                resetCommonCaches();
            }
        }
    }
```









